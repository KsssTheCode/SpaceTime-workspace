<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="commonMapper">

	<!-- 신고관리 -->
	<resultMap id="reportResultSet" type="report">
		<result column="REPORT_NO" property="reportNo" />
		<result column="REPORT_TYPE" property="reportType" />
		<result column="REPORT_CONTENT" property="reportContent" />
		<result column="REPORT_DATE" property="reportDate" />
		<result column="REPORT_STATUS" property="reportStatus" />
		<result column="REPORT_ANSWER" property="reportAnswer" />
		
		<result column="REPORTED_MEM_NO" property="reportedMemNo" />
		<result column="REPORT_MEM_NO" property="reportMemNo" />
	</resultMap>
	
	<!-- 매출관리  -->
	<resultMap id="reserveResultSet" type="reserve" >
		<result column="USE_DATE" property="useDate" />
		<result column="PRICE" property="price" />
		<result column="SPACE_NO" property="spaceNo" />
		
		<result column="MEM_NAME" property="memName" />
		<result column="MEM_ID" property="memId" />
		<result column="GENDER" property="gender" />
		
		<result column="SPACE_TITLE" property="spaceTitle" />
	</resultMap>
	
	<!-- 신고 글 총 개수 -->
	<select id="selectReportListCount" parameterType="hashmap" resultType="_int">
		SELECT COUNT(*)
		FROM REPORT
		<if test="tab == '전체 신고'">
			WHERE REPORT_STATUS IN ('Y', 'N', 'D')
		</if>
		<if test="tab == '미처리 신고'">
			WHERE REPORT_STATUS = 'N'
		</if>
		<if test="tab == '승인된 신고'">
			WHERE REPORT_STATUS = 'Y'
		</if>
		<if test="tab == '반려된 신고'">
			WHERE REPORT_STATUS = 'D'
		</if>
	</select>
	
	<!-- 신고 리스트 조회 -->
	<select id="selectReportList" parameterType="hashmap" resultMap="reportResultSet">
		SELECT REPORT_NO, MEM_ID AS "REPORTED_MEM_NO", REPORT_TYPE, REPORT_CONTENT, TO_CHAR(REPORT_DATE, 'YYYY-MM-DD') AS "REPORT_DATE", REPORT_STATUS
		FROM REPORT 
		JOIN MEMBER ON (REPORTED_MEM_NO = MEM_NO)
		<if test="tab == '전체 신고'">
			WHERE REPORT_STATUS IN ('Y', 'N', 'D')
		</if>
		<if test="tab == '미처리 신고'">
			WHERE REPORT_STATUS = 'N'
		</if>
		<if test="tab == '승인된 신고'">
			WHERE REPORT_STATUS = 'Y'
		</if>
		<if test="tab == '반려된 신고'">
			WHERE REPORT_STATUS = 'D'
		</if>
		ORDER BY REPORT_NO DESC
	</select> 
	
	<!-- 신고 상세조회 -->
	<select id="selectReport" parameterType="_int" resultMap="reportResultSet">
		SELECT REPORT_NO, M.MEM_ID AS "REPORT_MEM_NO", M2.MEM_ID AS "REPORTED_MEM_NO", REPORT_TYPE, REPORT_CONTENT, TO_CHAR(REPORT_DATE, 'YYYY-MM-DD') AS "REPORT_DATE", REPORT_STATUS, REPORT_ANSWER
		FROM REPORT
		JOIN MEMBER M ON (REPORT_MEM_NO = M.MEM_NO)
		JOIN MEMBER M2 ON (REPORTED_MEM_NO = M2.MEM_NO)
		WHERE REPORT_NO = #{reportNo}
	</select>
	
	<!-- 신고 처리 (승인, 반려) -->
	<update id="updateReport" parameterType="hashmap">
		UPDATE REPORT
		SET REPORT_STATUS = #{reportStatus}
			, REPORT_ANSWER = #{reportAnswer}
			, MODIFY_DATE = SYSDATE
		WHERE REPORT_NO = #{reportNo}
	</update>
	
	<!-- 매출이 있는 공간 총 개수 -->
	<select id="selectSalesListCount" resultType="_int">
		SELECT COUNT(*)
		FROM (SELECT SPACE_NO
			FROM RESERVE
			GROUP BY SPACE_NO)
		<!-- 날짜 선택 조건 나중에 넣기 -->
	</select>
	
	<!-- 매출이 있는 공간 리스트 조회 -->
	<select id="selectSalesList" resultMap="reserveResultSet">
		SELECT M.MEM_NAME, M.MEM_ID, SPACE_NO, S.SPACE_TITLE, (SUM(PRICE)*0.1) AS "PRICE", USE_DATE
		FROM RESERVE R
		JOIN SPACE S USING (SPACE_NO)
		JOIN MEMBER M ON (M.MEM_NO = HOST_NO)
		WHERE MEM_STATUS = 'N'
		GROUP BY SPACE_NO, MEM_NAME, MEM_ID, SPACE_TITLE, USE_DATE
		ORDER BY SPACE_NO DESC
		<!-- 날짜 선택 조건 나중에 넣기 -->
	</select>
	
	<!-- 공간별 매출 상세조회 -->
	<select id="selectSales" parameterType="_int" resultMap="reserveResultSet">
		SELECT M.MEM_NAME, M.MEM_ID, GENDER, SPACE_NO, S.SPACE_TITLE, (SUM(PRICE)*0.1) AS "INCOME"
		FROM RESERVE
		JOIN SPACE S USING (SPACE_NO)
		JOIN MEMBER M ON (M.MEM_NO = HOST_NO)
		WHERE SPACE_NO = #{SPACE_NO}
		GROUP BY SPACE_NO, MEM_NAME, MEM_ID, GENDER, SPACE_TITLE
	</select>
	
	<!-- 매출이 있는 공간의 상세 매출 총 개수 -->
	<select id="selectSalesDetailCount" resultType="_int">
		SELECT COUNT(*)
		FROM RESERVE
		WHERE SPACE_NO = #{SPACE_NO}
		<!-- 날짜 선택 조건 나중에 넣기 -->
	</select>
	
	<!-- 매출이 있는 공간의 상세 매출 조회 -->
	<select id="selectSalesDetailList" resultMap="reserveResultSet">
		SELECT TO_CHAR(USE_DATE, 'YYYY-MM-DD') AS "USE_DATE", R.START_TIME, PRICE, (PRICE*0.1) AS "INCOME"
		FROM RESERVE R
		WHERE SPACE_NO = #{SPACE_NO}
		ORDER BY USE_DATE ASC
		<!-- 날짜 선택 조건 나중에 넣기 -->
	</select>

	<!-- 검색어 자동완성 -->
	<select id="autoComplete" parameterType="string" resultType="arraylist">
		SELECT SPACE_TITLE
		FROM SPACE
		WHERE INSTR(SPACE_TITLE, #{keyword}) > 0
		AND SPACE_STATUS = 'Y'
	</select>
	
	<!-- 마이페이지 신고리스트 신희섭 -->
	<select id="selectMypageReportListCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM REPORT
	</select>
	
	<select id="selectMypageReportList" parameterType="_int" resultMap="reportResultSet">
		SELECT REPORT_NO
			, REPORT_TYPE
			, TO_CHAR(REPORT_DATE, 'YYYY-MM-DD') AS "REPORT_DATE"
			, REPORT_STATUS
			, REPORT_MEM_NO 
			, REPORT_CONTENT
			, REPORT_ANSWER
		FROM REPORT	 
		WHERE REPORT_MEM_NO = #{reportMemNo}
		ORDER BY REPORT_NO DESC
	</select>
</mapper>